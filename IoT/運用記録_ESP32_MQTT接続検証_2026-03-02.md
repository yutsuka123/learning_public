# ESP32 MQTT接続検証 運用記録（2026-03-02）

[重要] 本書は ESP32 から MQTT publish 成功までの実施設定と注意点を記録する。  
理由: 一時的な検証条件と最終運用条件を分離し、将来の設定逆戻りを防止するため。

## 1. 実施目的
- ESP32 が Wi-Fi 接続後に MQTT ブローカへ接続し、初回 publish（online通知）まで完了できることを確認する。

## 2. 実施結果
- [重要] `mqttfx` 上で publish 成功を確認済み。
- Wi-Fi は再試行強化ロジック（複数 attempt）により接続安定性が改善した。

## 3. 今回の実施設定（2026-03-02）
- ESP 側接続先:
  - MQTT Host: `172.16.1.59`
  - MQTT Port: `1883`
  - TLS: `false`（切り分けのため）
- ブローカ設定:
  - `mosquitto.conf` で `listener 1883`
  - `allow_anonymous true`（ローカル検証用途）
- Windows Firewall:
  - `mqtt` 受信ルールが有効
  - [注意] ネットワークプロファイル種別（Public/Private）とルール適用先が一致していること

## 4. 重要な注意点
- [厳守] ESP から見た `127.0.0.1` は ESP 自身を指すため、ブローカ接続先に使わない。
- [厳守] ブローカPCのネットワークプロファイルが `Public` の場合、`Private` 専用FWルールでは受信できない。
- [推奨] 接続失敗時は以下を順に確認する:
  - Wi-Fi接続状態（SSID/暗号方式/パスワード）
  - ブローカ待受（`0.0.0.0:1883` など）
  - FirewallルールのProfile一致（Public/Private）
  - ESP側 host/port/tls 設定値

## 5. 最終運用方針（本番形）
- [厳守] MQTT通信は TLS を有効化し、`8883` を使用する。
- [厳守] MQTT認証は ID/Password 必須とする（匿名接続禁止）。
- [厳守] 機密設定（Wi-Fi/MQTT認証情報）は NVS へ保存し、平文ファイル運用を廃止する。
- [推奨] ブローカ用ネットワークは専用LANまたはVLANで分離し、`Private` プロファイル運用へ移行する。
- [新規利用禁止] `1883 + allow_anonymous` を常用しない。

## 6. 旧仕様/暫定運用
- [旧仕様] 2026-03-02 時点の切り分けでは `1883 + TLS無効` を一時利用した。  
  理由: 接続性（FW/経路）問題と認証/TLS問題を分離して原因特定するため。

## 7. 変更履歴
- 2026-03-02: 新規作成。接続検証の実施設定、注意点、最終運用方針（NVS/Private/TLS）を記録。
