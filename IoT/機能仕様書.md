# IoT 機能仕様書

[重要] 本書は段階別の機能仕様を定義し、現行対象を第3段階に固定する。  
理由: 実装優先順位を明確化し、機能追加時の混線を防止するため。

## 1. 段階別機能

### 1.1 第1段階 [旧仕様]
- F1-001: ESP起動通知（MQTT Publish）
- F1-002: Local GUIからLED制御指令（MQTT Publish）
- F1-003: ESP側でLED制御指令の受信・反映（MQTT Subscribe）
- [廃止の方針] 本プロジェクトでは実施しない。

### 1.2 第2段階 [旧仕様]
- F2-001: LocalからFW書換モード遷移要求
- F2-002: ESPのHTTPS OTA（`esp_http_client`）
- F2-003: 分割転送、再開転送対応
- F2-004: OTA進捗MQTT通知（%と状態）
- F2-005: デュアルROM領域を交互利用した更新
- [廃止の方針] 本プロジェクトでは実施しない。

### 1.3 第3段階 [厳守: 現行実装]
- F3-001: ROM暗号化有効化後の正常起動
- F3-002: セキュアブート有効化後の署名検証起動
- F3-003: eFuse設定（必要項目）の適用と記録
- F3-004: MQTT接続でTLSを必須化し、証明書検証を実施する
- F3-005: MQTT接続でログインID/パスワード認証を必須化する
- F3-006: TLS/認証エラー時に接続拒否し、Localで原因判別可能なログを残す
- F3-007: 認証ロジック公開可能化（機密値分離）
- F3-008: Wi-Fi設定更新payloadをAES-256-GCMで復号し、改ざん時は破棄する
- F3-009: `base_mac` 由来の `public_id` でトピックを識別し、識別情報露出を抑える
- F3-010: Wi-Fi設定更新は「未確定保存 -> 接続成功後確定」の二段階確定にする
- F3-011: 新Wi-Fi接続失敗時に旧設定へ自動ロールバックする
- F3-012: AP復旧モード（メンテナンスモード）を提供する
  - AP名: `AP-esp32lab-<MAC>` / Pass: `pass-esp32`
  - Web UI経由でWi-Fi/MQTT設定が可能
- F3-013: 設定用外部APへの自動接続機能
  - AP名: `AP-esp32lab-setting` / Pass: `pass-esp32`
  - 接続失敗時の救済措置として機能する
- F3-014: MQTT経由でのネットワーク設定変更コマンド (`network`) の実装

### 1.4 第4段階 [将来対応]
- F4-001: Cloud認証連携（AWS/Google）
- F4-002: Cloud経由書換管理
- F4-003: 監査ログのクラウド集中管理

## 2. 状態遷移（ESP）
- `booting` -> `mqttTlsConnecting` -> `mqttAuthenticating` -> `running`
- [推奨] 状態遷移をMQTTへ逐次通知する。
- Wi-Fi更新時: `running` -> `wifiUpdatePending` -> `wifiReconnectTesting` -> `wifiConfirmWait` -> `running`
- ロールバック時: `wifiReconnectTesting` -> `wifiRollback` -> `running`
- 現地復旧時: `running` -> `apRecovery` -> `running`

## 3. 異常時要件
- TLS検証失敗時は接続を打ち切り、再試行間隔を設ける。
- MQTT認証失敗時は接続を打ち切り、再試行回数制限を適用する。
- 署名検証失敗時は旧ROM側へフォールバックする。
- eFuse適用不可時は処理停止し、Localへ失敗理由を通知する。
- Wi-Fi更新復号失敗/AES-GCM認証失敗時は設定適用を中止する。
- Wi-Fi更新の確定待ちタイムアウト時は旧設定へ戻す。

## 4. 変更履歴
- 2026-03-01: AP復旧モード（メンテナンスモード）の具体的仕様と設定用AP接続機能を追加。
- 2026-02-24: 新規作成。段階別機能と現行対象を整理。
- 2026-02-24: 第1/2段階を非対象化。第3段階にMQTT TLS + ID/パスワード認証機能を追加。
- 2026-02-24: Wi-Fi設定更新（AES-GCM、二段階確定、ロールバック、AP復旧）の機能を追加。
