# IoT 要件定義書

[重要] 本書は第3段階以降の実装要件を定義する。  
理由: 現在の実装優先範囲を固定し、段階混在による手戻りを防ぐため。

## 1. 適用範囲
- 対象: ESP32-S3 + Local（Windows/macOS GUI）構成
- 段階: 第3段階のみを実装対象、第4段階は将来要件として保持
- [廃止の方針] 第1段階・第2段階は本プロジェクトでは実施しない

## 2. 機能要件
- FR-001: MQTT接続をTLSで確立できること（第3段階）
- FR-002: MQTT接続時にログインID/パスワード認証を必須化できること（第3段階）
- FR-003: TLSハンドシェイク失敗時に接続拒否し、失敗理由をログ出力できること（第3段階）
- FR-004: ログイン認証失敗時に接続拒否し、失敗理由をログ出力できること（第3段階）
- FR-005: ROM暗号化を有効にした状態で動作できること（第3段階）
- FR-006: セキュアブートを有効にした状態で動作できること（第3段階）
- FR-007: 必要なeFuse設定を有効化し、設定状態を追跡できること（第3段階）
- FR-008: Wi-Fi設定更新payloadをAES-256-GCMで復号し、改ざん検知できること（第3段階）
- FR-009: `K_device = HMAC-SHA256(K_master_user, base_mac)` 方式でデバイス別鍵を利用できること（第3段階）
- FR-010: Wi-Fi設定更新は未確定保存し、MQTT再接続成功 + CONFIRM受信後に確定できること（第3段階）
- FR-011: 新設定接続失敗時に旧設定へ自動ロールバックできること（第3段階）
- FR-012: AP復旧モード（WPA2/固有パスワード/Web UI）で現地復旧できること（第3段階）
  - AP名: `AP-esp32lab-<MAC(no colon)>`, Pass: `pass-esp32`（将来機密化）
- FR-013: 設定用外部AP (`AP-esp32lab-setting`) が存在する場合、自動的に接続し設定を受け付けること（第3段階）
- FR-014: 初回セットアップ時にユーザー単位 `K_master_user` を生成し、セキュアストレージへ保存できること（第3段階）
- FR-015: 初回ペアリングで `base_mac` 取得 -> `K_device` 導出 -> デバイス保存を実施できること（第3段階）
- FR-016: `K_master_user` の暗号化バックアップ/復元が可能であること（第3段階）
- FR-017: MQTT経由でネットワーク設定（Wi-Fi/MQTT接続情報）を変更できること（第3段階）

## 3. 非機能要件
- NFR-001: [厳守] ESPターゲットはESP32-S3のみとする。理由: 機種差異の排除。
- NFR-002: [厳守] PlatformIOでビルドし、`platformio.ini`の依存バージョンを固定する。理由: 再現性確保。
- NFR-003: [厳守] 認証情報はGit管理禁止。理由: 機密漏えい防止。
- NFR-004: [推奨] 認証ロジックは機密値非依存な実装として公開可能にする。理由: 監査容易化。
- NFR-005: [厳守] MQTTはTLS必須（非TLSポート利用禁止）。理由: 通信路の機密性・完全性確保。
- NFR-006: [厳守] MQTTはID/パスワード認証必須。理由: 接続元の最低限認証を担保。
- NFR-007: [厳守] ESP実装言語はC/C++とする。理由: ESP-IDF資産との整合確保。
- NFR-008: [推奨] ESPのC++コードは可能な範囲でC++20を利用する。理由: 保守性向上。
- NFR-009: [厳守] Local実装はWindows/macOS両対応可能な構成とし、C#またはPythonを採用する。理由: クロスOS運用のため。
- NFR-010: [将来対応] Cloud実装言語はPython等を候補とし、実装開始時に確定する。理由: 要件未確定のため。
- NFR-011: [厳守] `K_master_user` はユーザーPCのセキュアストレージのみで管理し、Git保存禁止。理由: 鍵漏えい防止。
- NFR-012: [厳守] MQTT公開IDは `public_id`（base_macの直接公開禁止）を使用する。理由: 識別情報露出低減。
- NFR-013: [将来対応] MQTT認証はmTLS拡張可能な設計とする。理由: AWS連携時の移行容易化。

## 4. 制約条件
- [禁止] 実運用の鍵・証明書・トークンをリポジトリへ保存しない。
- [新規利用禁止] ハードコードされた固定秘密値（例: APIキー文字列）の新規追加を禁止。
- [禁止] 自己署名証明書の検証スキップ（開発一時対応を恒久化する運用）。
- [将来対応] Cloud認証はAWS/Googleいずれかを選定し、第4段階で要件確定する。
- [厳守] Wi-Fi MACをdevice_id用途に使用しない（変更可能なため）。
- [厳守] メーカー共通鍵（`K_master_global`）を導入しない。

## 5. 受入観点（第3段階）
- MQTT接続がTLSで成立し、証明書検証に失敗した場合に接続が拒否されること。
- MQTT接続がID/パスワード認証で成立し、認証失敗時に接続が拒否されること。
- ROM暗号化 + セキュアブート + eFuse有効の構成で、MQTT接続機能が維持されること。
- 認証情報を含むファイルがGit差分に現れないこと。
- Wi-Fi設定誤投入時、タイムアウト後に旧設定へロールバックし遠隔管理を継続できること。
- base_mac直接公開なしで `public_id` ベースのMQTT運用が成立すること。
- バックアップ復元後に既存デバイスとの暗号通信を継続できること。

## 6. 変更履歴
- 2026-03-01: ネットワーク設定変更要件（MQTT/APモード/外部AP救済）を追加。
- 2026-02-24: 新規作成。第3段階優先の要件に整理。
- 2026-02-24: 第1/2段階を非対象化し、第3段階にMQTT TLS + ID/パスワード認証要件を追加。
- 2026-02-24: 言語要件（ESP: C/C++/C++20推奨、Local: C#/Python、Cloud: Python等）を追加。
- 2026-02-24: Wi-Fi設定更新設計（AES-GCM、K_master_user導出、二段階確定、ロールバック、AP復旧）要件を追加。
- 2026-02-24: オンプレ独立前提として `K_master_user` 生成/ペアリング/バックアップ要件を追加。
