# IoT 要件定義書

[重要] 本書は第3段階以降の実装要件を定義する。  
理由: 現在の実装優先範囲を固定し、段階混在による手戻りを防ぐため。

## 1. 適用範囲
- 対象: ESP32-S3 + Local（Windows/macOS GUI）構成
- 段階: 第3段階のみを実装対象、第4段階は将来要件として保持
- [廃止の方針] 第1段階・第2段階は本プロジェクトでは実施しない

## 2. 機能要件
- FR-001: MQTT接続をTLSで確立できること（第3段階）
- FR-002: MQTT接続時にログインID/パスワード認証を必須化できること（第3段階）
- FR-003: TLSハンドシェイク失敗時に接続拒否し、失敗理由をログ出力できること（第3段階）
- FR-004: ログイン認証失敗時に接続拒否し、失敗理由をログ出力できること（第3段階）
- FR-005: ROM暗号化を有効にした状態で動作できること（第3段階）
- FR-006: セキュアブートを有効にした状態で動作できること（第3段階）
- FR-007: 必要なeFuse設定を有効化し、設定状態を追跡できること（第3段階）

## 3. 非機能要件
- NFR-001: [厳守] ESPターゲットはESP32-S3のみとする。理由: 機種差異の排除。
- NFR-002: [厳守] PlatformIOでビルドし、`platformio.ini`の依存バージョンを固定する。理由: 再現性確保。
- NFR-003: [厳守] 認証情報はGit管理禁止。理由: 機密漏えい防止。
- NFR-004: [推奨] 認証ロジックは機密値非依存な実装として公開可能にする。理由: 監査容易化。
- NFR-005: [厳守] MQTTはTLS必須（非TLSポート利用禁止）。理由: 通信路の機密性・完全性確保。
- NFR-006: [厳守] MQTTはID/パスワード認証必須。理由: 接続元の最低限認証を担保。
- NFR-007: [厳守] ESP実装言語はC/C++とする。理由: ESP-IDF資産との整合確保。
- NFR-008: [推奨] ESPのC++コードは可能な範囲でC++20を利用する。理由: 保守性向上。
- NFR-009: [厳守] Local実装はWindows/macOS両対応可能な構成とし、C#またはPythonを採用する。理由: クロスOS運用のため。
- NFR-010: [将来対応] Cloud実装言語はPython等を候補とし、実装開始時に確定する。理由: 要件未確定のため。

## 4. 制約条件
- [禁止] 実運用の鍵・証明書・トークンをリポジトリへ保存しない。
- [新規利用禁止] ハードコードされた固定秘密値（例: APIキー文字列）の新規追加を禁止。
- [禁止] 自己署名証明書の検証スキップ（開発一時対応を恒久化する運用）。
- [将来対応] Cloud認証はAWS/Googleいずれかを選定し、第4段階で要件確定する。

## 5. 受入観点（第3段階）
- MQTT接続がTLSで成立し、証明書検証に失敗した場合に接続が拒否されること。
- MQTT接続がID/パスワード認証で成立し、認証失敗時に接続が拒否されること。
- ROM暗号化 + セキュアブート + eFuse有効の構成で、MQTT接続機能が維持されること。
- 認証情報を含むファイルがGit差分に現れないこと。

## 6. 変更履歴
- 2026-02-24: 新規作成。第3段階優先の要件に整理。
- 2026-02-24: 第1/2段階を非対象化し、第3段階にMQTT TLS + ID/パスワード認証要件を追加。
- 2026-02-24: 言語要件（ESP: C/C++/C++20推奨、Local: C#/Python、Cloud: Python等）を追加。
