# ESP32-S3 デバイス情報 取得方法

[重要] 本手順はWindowsでCOMポート接続されたESP32-S3を対象にしています。  
理由: 取得コマンドと出力解釈を標準化し、再現性を確保するため。

[厳守] 取得時に得られる認証情報（鍵・パスワード等）は保存・共有しないこと。  
理由: セキュリティインシデント防止のため。

## 1. 事前確認
- Pythonが利用可能であること
- `esptool` / `espefuse` が利用可能であること

確認コマンド:
- `python -m esptool version`

## 2. COMポート確認（Windows PowerShell）
- `Get-PnpDevice -Class Ports | Select-Object Status,Class,FriendlyName,InstanceId | Format-List`

## 3. チップ情報の取得
- `python -m esptool --port COM9 chip_id`

取得できる主な情報:
- チップ型番
- リビジョン
- 機能（WiFi/BLE/PSRAM）
- MAC

## 4. Flash情報の取得
- `python -m esptool --port COM9 flash_id`

取得できる主な情報:
- Flash容量
- Flashベンダ/デバイス
- Flash配線設定（quadなど）

## 5. MACの取得
- `python -m esptool --port COM9 read_mac`

## 6. eFuse要約の取得
- `python -m espefuse --port COM9 summary`

確認観点（第3段階向け）:
- `SPI_BOOT_CRYPT_CNT`（Flash Encryption有効/無効）
- `SECURE_BOOT_EN`（Secure Boot有効/無効）
- `ENABLE_SECURITY_DOWNLOAD` / `DIS_DOWNLOAD_MODE`

## 7. ROMアドレス/構成の取得
- 単一アドレス読出し:
  - `python -m esptool --port COM9 read_mem 0x40000000`
- 複数アドレスを確認して構成を推定:
  - `python -m esptool --port COM9 read_mem 0x40010000`
  - `python -m esptool --port COM9 read_mem 0x40020000`
  - `python -m esptool --port COM9 read_mem 0x40030000`
- ROMダンプ（先頭1KB例）:
  - `python -m esptool --port COM9 dump_mem 0x40000000 0x00000400 IoT/ESP32/deviceInfo/rom_dump_0x40000000_0x400.bin`

補足:
- `0xbad00bad` が返る場合は、そのアドレスが現在有効でないか読み出し対象外の可能性が高い。
- ROMの完全なセクション構成は、TRMのメモリマップと突合して確定する。

## 8. パーティション構成の取得
- パーティションテーブル領域を読出し:
  - `python -m esptool --port COM9 read_flash 0x8000 0x1000 IoT/ESP32/deviceInfo/partition_table_0x8000_0x1000.bin`
- 読出しバイナリをCSVへ変換して保存する。
- [推奨] 変換後CSVは `IoT/ESP32/partitions/` にも配置し、`platformio.ini` から参照する。

補足:
- ESP32系ではパーティションテーブルのオフセットは通常 `0x8000`。
- 実機構成は必ず読出し結果を根拠とし、推測で編集しない。

## 9. RAM情報の取得（補足）
- RAM空き量はFW実行中にAPIで取得する（例: `heap_caps_get_free_size`）。
- [推奨] 起動時にシリアルまたはMQTTで定期出力する実装を追加する。

## 10. 変更履歴
- 2026-02-24: 新規作成。実機接続時の標準取得手順を定義。
- 2026-02-24: ROMアドレス確認とROMダンプ手順を追記。
- 2026-02-24: パーティションテーブル取得手順を追記。
