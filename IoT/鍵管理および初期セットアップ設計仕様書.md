# 鍵管理および初期セットアップ設計仕様書（オンプレ独立前提）

[重要] 本仕様はユーザーごとに独立したオンプレ運用を前提とした鍵管理方式を定義する。  
理由: ユーザー間分離とサポート時の安全性を両立するため。

## 1. 前提
- ユーザーごとにローカルPC上へサーバーをセットアップする。
- ユーザーごとにシステムは完全独立する。
- ユーザー間で鍵・データを共有しない。
- [将来対応] クラウド版との共存を想定する。

## 2. 鍵階層設計
### 2.1 鍵構造
- `User -> K_master_user -> K_device(デバイス単位)`
- [厳守] メーカー共通鍵（`K_master_global`）は使用しない。

### 2.2 K_master_user
- 定義: ユーザー単位のマスター鍵。
- 生成者: ユーザーPC上のセットアッププログラム（セットアップexe）。
- 生成タイミング: サーバー初回セットアップ時。
- 生成方法:
  - OSの暗号学的乱数生成器（CSPRNG）を使用
  - 256bitランダム値を生成
- 保存場所:
  - Windows: DPAPI等のセキュアストレージ
  - macOS: Keychain
- セキュリティ方針:
  - ネットワーク上へ送信しない
  - ログへ出力しない
  - 平文ファイルとして保存しない

## 3. デバイス鍵設計
### 3.1 device_id
- [厳守] `device_id` はESP32 eFuse base MACを使用する。
- [禁止] Wi-Fi MACはdevice_id用途で使用しない。

### 3.2 K_device生成式
- `K_device = HMAC-SHA256(K_master_user, base_mac)`

### 3.3 デバイス保存内容
- 保存対象:
  - `base_mac`（eFuse）
  - `K_device`
- [厳守] `K_master_user` はデバイスに保存しない。

## 4. 初回ペアリング設計
### 4.1 ペアリング方式
- 未登録デバイスはAPモードで起動する。
- 物理ボタン操作でAPモードを有効化する。
- [厳守] APモードはWPA2保護必須。

### 4.2 ペアリング手順
- ユーザーPCがAPへ接続
- デバイスから`base_mac`取得
- ユーザーPCで`K_device`算出
- `K_device`をデバイスへ送信
- デバイスに保存
- APモード無効化

### 4.3 セキュリティ制限
- APモードは短時間のみ有効
- 物理操作なしでは再登録不可
- 登録後は通常運用のみ許可

## 5. Wi-Fi設定変更設計
### 5.1 通信方式
- MQTT over TLS
- Wi-Fi設定はアプリ層でAES-256-GCM暗号化

### 5.2 暗号鍵
- `K_device` を暗号鍵として使用

### 5.3 更新フロー
- MQTTで暗号化設定受信
- 復号
- 新設定を未確定保存
- 接続試験
- MQTT再接続成功時に確定
- 失敗時ロールバック

## 6. バックアップ設計
### 6.1 バックアップ対象
- `K_master_user`
- メタデータ（作成日時・バージョン）

### 6.2 バックアップ形式
- 暗号化ファイル
- ユーザー指定パスフレーズでAES-GCM暗号化

### 6.3 復元手順
- セットアップexe実行
- 「バックアップから復元」選択
- パスフレーズ入力
- `K_master_user`復元
- セキュアストレージ保存

### 6.4 バックアップ無しの場合
- 新`K_master_user`生成
- 全デバイス再ペアリングが必要

## 7. サポート方針
### 7.1 ユーザー完全独立原則
- [厳守] メーカーは`K_master_user`を保持しない。
- [厳守] 常時アクセス可能なメーカー共通鍵を持たない。

### 7.2 サポート方式
- 標準:
  - ユーザーがサポートパッケージを生成
  - ログ・状態情報をメーカーへ提供
- 必要時:
  - ユーザー同意のもとリモート操作
  - または時限サポートトークン方式

## 8. 将来クラウド併用時の設計
### 8.1 原則
- ユーザー単位`K_master_user`は維持する。
- クラウドではKMS管理とする。
- オンプレと鍵階層は共通にする。

## 9. セキュリティ到達目標
- 最低限:
  - MQTT TLS
  - デバイス個別鍵
  - AES-GCM暗号
- 強化:
  - Flash Encryption
  - Secure Boot
  - JTAG無効化

## 10. 設計思想まとめ
- ユーザー完全独立
- 鍵はユーザー単位で分離
- デバイス単位鍵で物理攻撃影響を限定
- メーカー共通バックドアを作らない
- バックアップにより復旧可能
- サポートはユーザー同意型

## 11. 変更履歴
- 2026-02-24: 新規作成。オンプレ独立前提の鍵管理・初期セットアップ仕様を定義。
