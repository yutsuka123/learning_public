# 鍵管理・初期セットアップ 実装たたき台

[重要] 本書は `鍵管理および初期セットアップ設計仕様書.md` の実装着手用ドラフトである。  
理由: 実装順序と責務分担を先に固定し、手戻りを防ぐため。

[厳守] 本書には鍵実値・秘密情報を記載しない。  
理由: 公開リポジトリ運用のため。

## 1. スコープ（第1版）
- 対象:
  - `K_master_user` 生成・保存（Windows/macOS）
  - 初回ペアリング（APモード）
  - `K_device` 導出/書込み
  - Wi-Fi更新での暗号payload受信準備
  - `K_master_user` バックアップ/復元の最小機能
- 対象外（次版）:
  - クラウドKMS連携
  - 高度なサポートトークン機構

## 2. 実装フェーズ案
### Phase 1: セットアップ基盤
- セットアップexeで `K_master_user` をCSPRNGで生成（256bit）
- OSセキュアストレージ保存
  - Windows: DPAPI
  - macOS: Keychain
- 失敗時のエラー設計
  - 例: 保存失敗、権限不足、再試行中断

### Phase 2: 初回ペアリング
- デバイスAPモード起動（物理操作必須）
- PCツールから `base_mac` 取得
- `K_device = HMAC-SHA256(K_master_user, base_mac)` を導出
- `K_device` をデバイスへ送信・保存
- APモード終了、通常モードへ移行

### Phase 3: Wi-Fi更新フロー最小実装
- 暗号payload受信インターフェース定義
- AES-256-GCM復号処理
- 未確定保存 -> 接続試験 -> 確定/ロールバックの状態遷移実装

### Phase 4: バックアップ/復元
- `K_master_user` + メタデータをAES-GCMで暗号化バックアップ
- パスフレーズ入力で復元
- 復元後セキュアストレージへ再保存

## 3. モジュール案（PC側）
- `setup-core`:
  - 鍵生成、鍵保管、メタデータ管理
- `pairing-client`:
  - AP接続、base_mac取得、K_device書込み
- `backup-manager`:
  - 暗号化バックアップ生成/復元
- `support-package`:
  - 鍵を含まない診断情報パッケージ生成

## 4. モジュール案（ESP側）
- `certification.cpp`:
  - K_device受入・認証・検証API
- `filesystem.cpp`:
  - NVS/LittleFS保存処理（鍵はNVS想定）
- `wifi.cpp`:
  - APモード/通常モード切替
- `mqtt.cpp`:
  - update/confirm受信
- `input.cpp`:
  - 物理ボタン長押し検知（AP復旧）

## 5. データ項目たたき台
### 5.1 セキュアストレージ（PC）
- `kMasterUser`（256bit）
- `keyVersion`
- `createdAt`

### 5.2 デバイス保存
- `baseMac`
- `kDevice`
- `kDeviceVersion`
- `provisioningState`（未登録/登録済）

## 6. APIたたき台
### 6.1 セットアップAPI（PC内）
- `createMasterKey() -> bytes`
- `saveMasterKeySecurely(bytes) -> bool`
- `loadMasterKeySecurely() -> bytes`

### 6.2 ペアリングAPI
- `readBaseMacFromDevice() -> string`
- `deriveDeviceKey(kMasterUser, baseMac) -> bytes`
- `writeDeviceKeyToDevice(kDevice) -> bool`

### 6.3 バックアップAPI
- `exportMasterKeyBackup(passphrase) -> file`
- `importMasterKeyBackup(file, passphrase) -> bytes`

## 7. 試験観点たたき台
- 鍵生成:
  - 毎回異なる鍵が生成される
  - セキュアストレージ保存失敗時に異常終了できる
- ペアリング:
  - 未登録時のみ実行可能
  - 物理操作なし再登録不可
- Wi-Fi更新:
  - 復号失敗時に設定反映しない
  - 確定前失敗でロールバックする
- バックアップ:
  - 正しいパスフレーズで復元成功
  - 誤パスフレーズで復元拒否

## 8. リスクと対策たたき台
- リスク: セキュアストレージ差異（OS間）
  - 対策: 共通インターフェース + OS別実装
- リスク: ペアリング手順の現場難易度
  - 対策: GUIウィザード化 + タイムアウト/再試行誘導
- リスク: 旧設定ロールバック不全
  - 対策: 状態機械テスト + 強制失敗試験

## 9. 先行実装順（提案）
1) `log.cpp` と `filesystem.cpp` の基盤実装  
2) `certification.cpp` に `K_device` 保存/読出し  
3) `wifi.cpp` に APモード入口  
4) PC側セットアップ最小CLI（生成・保存・導出）  
5) ペアリング連携  
6) Wi-Fi更新ステートマシン

## 10. 変更履歴
- 2026-02-24: 初版たたき台作成。
