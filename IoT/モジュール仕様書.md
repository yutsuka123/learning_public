# IoT モジュール仕様書

[重要] 本書は `IoT` 配下モジュールの責務を定義する。  
理由: 実装担当の境界を明確化し、修正影響範囲を把握しやすくするため。

## 1. 想定フォルダ構成
- `IoT/ESP32/`  
  ESP32-S3向けファームウェア（MQTT通信、TLS認証、セキュリティ機能）
- `IoT/ESP32/header/`  
  ESP専用ヘッダ群（タスクIF、`define.h`、`mqttProtocol.h`、`httpProtocol.h` など）
- `IoT/ESP32/src/`  
  ESP実装本体（各タスク実装、`mqttProtocol.cpp`、`httpProtocol.cpp` など）
- `IoT/shared/include/`  
  ESP/Local/Cloudで共有する公開定義（`common.h`）
- `IoT/local/`  
  Local GUIアプリ、MQTTクライアント制御
- `IoT/cloud/`  
  [将来対応] Cloud連携、認証、更新管理
- `IoT/docs/`  
  [将来対応] 追加設計書・試験証跡（必要時）

## 2. モジュール責務
- ESPモジュール:
  - MQTT TLS接続、ID/パスワード認証、セキュリティ設定反映
  - Wi-Fi設定更新（AES-GCM復号、二段階確定、ロールバック、AP復旧）
  - 実装言語: C/C++（[推奨] C++20）
- Localモジュール:
  - GUI操作、MQTT（TLS）送受信、認証状態可視化
  - 暗号化payload生成（public_id指定、confirm送信）
  - 実装言語: C# または Python（Windows/macOS両対応）
- Cloudモジュール:
  - デバイス認証、配信制御、監査ログ
  - K_master_user安全管理、K_device導出、MQTT ACL管理
  - 実装言語: Python等（未定）

## 3. 現行実装対象
- [厳守] 第3段階のみを実施対象とする。
- [廃止の方針] 第1段階・第2段階（特にOTA関連）は現行スコープから除外する。

## 4. セキュリティ境界
- [厳守] 認証情報は `IoT/` 配下に保存しない（必要時はローカル安全領域参照）。
- [推奨] 認証ロジックは `authLogic` 等の非機密モジュールとして分離実装する。

## 5. 変更履歴
- 2026-02-24: 新規作成。初期モジュール責務を定義。
- 2026-02-24: 第3段階のMQTT TLS + ID/パスワード認証前提へ責務を更新。
- 2026-02-24: モジュールごとの実装言語方針を追記。
- 2026-02-24: Wi-Fi設定更新暗号/ロールバック/AP復旧とK_master_user管理責務を追記。
- 2026-02-24: `IoT/ESP32/header` 集約方針、`IoT/shared/include/common.h` の共有配置、通信プロトコル定義モジュール（MQTT/HTTPS）を追記。
