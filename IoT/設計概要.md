# IoT 設計概要

[重要] 本プロジェクトは ESP32-S3 / Local / Cloud で構成するIoT基盤の段階実装を目的とする。  
理由: 将来のCloud連携を見据えて、現行段階（第3段階）を破綻なく設計するため。

## 1. 目的
- ESP32-S3 と Local アプリ間で安全に制御・状態取得できる構成を確立する。
- 第3段階として、ROM暗号化・セキュアブート・eFuse有効化を前提にした運用へ移行する。
- 第3段階として、MQTT通信をTLS + ログインID/パスワード認証でセキュア化する。

## 2. 構成要素
- ESP（ESP32-S3）
- Local（Windows/macOS GUIアプリ + ローカルMQTTブローカ）
- Cloud（将来対応: 認証・配信基盤）

## 2.1 言語方針
- [厳守] ESP実装は C/C++ を採用する。
- [推奨] ESPのC++実装は可能な範囲で C++20 を利用する。  
  理由: 可読性・型安全性・保守性を高めるため。
- [厳守] Local実装は Windows/macOS の両対応を前提とし、C# または Python を採用する。
- [将来対応] Cloud実装は Python 等を候補とし、第4段階で確定する。

## 3. 段階計画
- [廃止の方針] 第1段階: 本プロジェクトでは実施しない。理由: 第3段階セキュリティ実装を優先するため。
- [廃止の方針] 第2段階: 本プロジェクトでは実施しない。理由: OTA機能より先に通信路保護を完了させるため。
- [厳守] 第3段階（現行対象）: ROM暗号化、セキュアブート、eFuse有効化に加え、MQTTをTLS + ログインID/パスワード認証で運用する。
- [将来対応] 第4段階: Cloudで認証・書換管理（AWS/Google想定）へ拡張。

## 4. 設計方針
- [厳守] ESPビルドは PlatformIO を使用し、`platformio.ini` にライブラリバージョンを固定記載する。  
  理由: ビルド再現性とセキュリティ検証の再実行性を担保するため。
- [厳守] 対象チップは ESP32-S3 固定。  
  理由: セキュリティ機能検証の対象差分を抑えるため。
- [禁止] 認証情報（鍵、トークン、秘密値）をGitへアップロードしない。  
  理由: 漏えい時の影響が甚大で回復困難なため。
- [推奨] 認証ロジックは公開可能部分としてモジュール分離する。  
  理由: 秘密情報非依存のコードレビューと再利用性を高めるため。
- [厳守] MQTTブローカ接続はTLSを必須とし、平文MQTT（1883）を利用しない。  
  理由: 通信盗聴・改ざんリスクを低減するため。
- [厳守] MQTT接続時はログインID/パスワード認証を必須とする。  
  理由: 不正クライアント接続を抑止するため。
- [厳守] Wi-Fi設定更新 payload はアプリ層暗号（AES-256-GCM）で保護する。  
  理由: ブローカ内部ログ/誤配信時の漏えいリスクを低減するため。
- [厳守] 鍵方式は `K_master_user` から `K_device` を導出する方式を採用する。  
  理由: デバイス個別鍵と運用容易性（対応表不要）を両立するため。
- [厳守] Wi-Fi設定は二段階確定（未確定保存→接続成功後確定）とし、失敗時は旧設定へロールバックする。  
  理由: 誤設定による遠隔喪失を防ぐため。
- [推奨] 現地復旧としてAPモード（WPA2/固有パスワード/Web UI）を実装する。  
  理由: 最悪時の保守性を担保するため。

## 5. セキュリティ境界
- 公開可: 通信フロー、状態遷移、検証ロジック、署名検証の一般処理。
- 非公開: 秘密鍵、実トークン、証明書実体、実運用エンドポイントの機密設定。

## 6. 仕様変更履歴
- 2026-02-24: 第3段階からの実装方針を明文化。認証情報のGit禁止を明記。
- 2026-02-24: 第1/2段階を実施対象外へ変更。第3段階にMQTT TLS + ID/パスワード認証を追加。
- 2026-02-24: 言語方針を追記（ESP: C/C++、C++20推奨、Local: C#/Python、Cloud: Python等）。
- 2026-02-24: Wi-Fi設定更新設計（AES-GCM、K_master_user方式、二段階確定、AP復旧）を追加。
