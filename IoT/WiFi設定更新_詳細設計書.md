# Wi-Fi設定更新 詳細設計書

[重要] 本書は屋外設置後のWi-Fi AP変更に対応するための詳細設計を定義する。  
理由: 現地作業を最小化しつつ、誤設定時の復旧性と安全性を両立するため。

## 1. 目的
- 遠隔でWi-Fi設定を変更可能にする。
- 誤設定時に自動ロールバック可能にする。
- 最悪時に現地復旧可能（APモード復旧）とする。

## 2. 基本アーキテクチャ（通信分離）
- OTA開始指令: MQTT
- OTAバイナリ転送: HTTPS
- Wi-Fi設定変更: MQTT
- Wi-Fi設定暗号化: アプリ層暗号（AES-256-GCM）

[厳守] 制御メッセージと大容量データ転送を分離する。  
理由: 運用安定性と再試行制御を簡潔化するため。

## 3. MQTTセキュリティ要件
- [厳守] MQTT over TLS
- [厳守] サーバ証明書検証必須
- [将来対応] AWS連携を見据え、mTLSへ移行可能な設計にする

## 4. Wi-Fi設定暗号化設計
### 4.1 暗号方式
- [厳守] AES-256-GCM（認証付き暗号）を採用する。

### 4.2 鍵設計（マスター鍵方式）
- [厳守] `K_master_user` はユーザー単位で生成し、ユーザー環境のみで保持する（Git保存禁止）。
- [厳守] デバイス鍵は都度導出する。
  - `K_device = HMAC-SHA256(K_master_user, base_mac)`

### 4.3 設計特性
- デバイスごとにユニーク鍵
- サーバ側は固定対応表不要（導出計算で生成）
- base_mac既知でも `K_master_user` が安全なら `K_device` は保護される
- ユーザー間で鍵階層が分離される

## 5. device_id / public_id 設計
- [厳守] `device_id` は eFuse base MAC を使用する（Wi-Fi MAC不採用）。
- [厳守] MQTT上では base_mac を直接公開せず、`public_id` を使用する。
  - 例: `public_id = SHA256(base_mac)` の先頭8バイト
- MQTTトピック例:
  - `device/<public_id>/wifi/update`

## 6. デバイス側鍵保存
- 初期フェーズ:
  - 製造時に `K_device` をNVSへ書き込み
- 強化フェーズ:
  - Flash Encryption有効
  - Secure Boot有効

## 7. Wi-Fi設定変更フロー（ステートマシン）
- MQTTで暗号化payload受信
- AES-GCMで復号
- 新設定を「未確定」で保存
- 新APへ接続試行
- MQTT再接続成功
- CONFIRM受信後に確定保存
- 失敗時:
  - 一定時間内に再接続できない場合は旧設定へロールバック

## 8. フェイルセーフ
- [厳守] 新Wi-Fi設定を即確定しない
- [厳守] 確定条件は「MQTT再接続成功 + CONFIRM受信」
- [厳守] タイムアウトと旧設定保持を必須化する

## 9. 現地復旧（APモード / メンテナンスモード）
### 9.1 APモード復旧（モード②）
- **トリガー**:
  - ボタン長押し
  - Wi-Fi接続失敗回数しきい値超過
- **AP設定**:
  - SSID: `AP-esp32lab-<MAC(no colon)>` (例: `AP-esp32lab-A1B2C3D4E5F6`)
  - Pass: `pass-esp32`
- **機能**:
  - Webサーバーを起動し、設定画面を提供する。
  - Wi-Fi SSID/Pass, MQTT接続情報の変更が可能。
- **セキュリティ**:
  - 将来的にSSID/Passは機密化する。

### 9.2 設定用外部AP接続（モード③）
- **概要**:
  - 既存設定でWi-Fi接続できない場合、救済措置として特定の設定用APを探して接続する。
- **AP設定**:
  - SSID: `AP-esp32lab-setting`
  - Pass: `pass-esp32`
- **動作**:
  - 接続成功後、デバイスは設定待ち受け状態（Webサーバー起動または所定のMQTT接続）となる。
  - 基本的にモード②と同様の設定機能を提供する。

## 10. MQTT経由の設定変更（モード①）
- [厳守] `K_master_user` はユーザーPCのセキュアストレージで安全保管しGitへ保存しない
- [厳守] `device_id` から `K_device` を都度導出
- [厳守] MQTT ACLで他デバイス購読を禁止
- [厳守] 暗号化payload生成機能を提供

## 11. セキュリティ到達目標
- 最低達成:
  - MQTT TLS
  - デバイス別鍵
  - AES-GCM暗号
- 目標達成:
  - Flash Encryption
  - Secure Boot
  - JTAG無効化（最終段階）

## 12. 今回確定した重要判断
- 共通鍵は使わない
- base MACをdevice_idとして使用
- `K_master_user` 方式採用
- Wi-Fi設定はアプリ層暗号化
- ロールバック必須
- AP復旧機能を実装

## 13. 全体要約
- `K_master_user` に基づくデバイス個別鍵でWi-Fi設定をAES-GCM暗号化し、MQTT(TLS)で配信する。  
- 二段階確定とロールバックを備え、最終的にFlash Encryption + Secure Bootで物理耐性を確保する。

## 14. オンプレ独立前提の補足
- [厳守] システムはユーザー単位で完全独立する（鍵・データ共有禁止）。
- [推奨] 初回ペアリングはAPモード + 物理操作で実施する。
- [推奨] `K_master_user` の暗号化バックアップ/復元手順を用意する。
- [将来対応] クラウド移行時もユーザー単位鍵階層を維持する。

## 15. 変更履歴
- 2026-03-01: ネットワーク設定（MQTT/APモード/設定用外部AP）の仕様追加。
- 2026-02-24: 新規作成。Wi-Fi設定更新設計（暗号化/ロールバック/AP復旧）を確定事項として記録。
- 2026-02-24: オンプレ独立前提に合わせ `K_master_user` 方式へ更新し、独立運用補足を追加。
